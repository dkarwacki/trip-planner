---
description: Playwright E2E testing patterns and conventions for this project
globs: e2e/**/*.ts, e2e/**/*.spec.ts
alwaysApply: false
---

# Playwright E2E Testing Guidelines

## Project Structure

- **Test files** go in `e2e/` directory with `.spec.ts` extension
- **Organize tests by feature area** - group related test cases in same file (e.g., `map-autocomplete.spec.ts`, `map-discover.spec.ts`)
- **Page Objects** go in `e2e/pages/` directory with `{Name}Page.ts` naming
- **Auth setup** lives in `e2e/auth.setup.ts` - runs before all tests
- **Export all Page Objects** from `e2e/pages/index.ts`

## Page Object Model Pattern

- **ALWAYS extend BasePage** for shared functionality
- **Define locators in constructor** using `readonly` properties
- **Use `getByTestId()` for element selection** - NEVER use CSS selectors or XPath
- **Name methods descriptively**: `typeInDesktopSearch()`, `waitForSuggestions()`, `gotoMap()`
- **Return Locator for element getters**, use `async` for actions
- **Group related locators** with comment sections (e.g., `// Authentication Locators`, `// Form Locators`)
- **Organize methods by type**: action methods, wait methods, getter methods

## Test ID Conventions

- **ALWAYS use `data-testid` attributes** in components for test selectors
- **Use kebab-case** for test IDs: `login-email-input`, `place-search-bar`
- **Add test IDs inside components**, not on external usage
- **Naming patterns**:
  - Containers: `{component-name}` (e.g., `login-form`, `map-desktop-layout`)
  - Inputs: `{context}-{type}-input` (e.g., `login-email-input`)
  - Buttons: `{action}-button` (e.g., `login-submit-button`)
  - Results: `{component}-item` (e.g., `search-result-item`)

## Test Structure

- **Use `test.describe()` for grouping** related tests by feature or viewport
- **Use `test.beforeEach()` for setup** - instantiate Page Objects here
- **Reference test case IDs** in describe block names: `"Feature Name - TC-XXX-001"`
- **Add JSDoc comments** explaining what the test validates
- **Follow Arrange, Act, Assert pattern** in test bodies

## Authentication

- **Auth runs once via setup project** - saves state to `playwright/.auth/user.json`
- **All tests use stored auth state** - no login needed in individual tests
- **Credentials from environment variables**: `E2E_USERNAME`, `E2E_PASSWORD`
- **Wait for form AND inputs** before interacting - see [React/Astro Hydration](#reactastro-hydration)

## Viewport Testing

- **Desktop is default** from playwright.config.ts (Desktop Chrome)
- **Set mobile viewport explicitly** in tests: `await page.setViewportSize({ width: 390, height: 844 })`
- **Create separate describe blocks** for desktop and mobile tests
- **Page Objects should support both** with viewport-specific methods when needed

## React/Astro Hydration

This project uses Astro with React islands. HTML may render before React hydrates, causing timing issues.

- **ALWAYS wait for inputs before filling** - use `waitFor({ state: "visible" })` before `fill()`
- **Clear inputs before filling** - handles edge cases where values persist
- **Use `networkidle` for form submissions** that trigger navigation
- **Wait for containers, then inputs** - form visible â‰  inputs ready

## Assertions

- **Use `expect()` with specific matchers**: `toBeVisible()`, `toHaveURL()`, `toHaveValue()`
- **Wait for elements before asserting**: `await expect(locator).toBeVisible()`
- **Use `.waitFor()` for dynamic content**: `await dropdown.waitFor({ state: "visible" })`
- **Avoid arbitrary timeouts** - use proper waits instead of `page.waitForTimeout()`

## Race Condition Handling

Fast async operations (loading states, API calls) may complete before tests can observe them.

- **Check if loading is visible** with `.isVisible().catch(() => false)` before waiting
- **Always verify final state** - use `expect(...).not.toBeVisible()` after operation completes
- **Wait methods should handle race conditions** - try-catch with short timeout to catch loading, then verify it's gone if still visible

## Network Request Verification

- **Set up request listeners BEFORE triggering actions** - use `page.waitForRequest()` with URL matcher and timeout
- **Verify parallel requests** - use `Promise.all()` with multiple `waitForRequest()` calls
- **Validate request payloads** - use `request.postDataJSON()` to access body, then assert properties

## State Verification Patterns

- **Multiple possible valid states** - check each state with `.isVisible().catch(() => false)`, then assert at least one is true
- **Conditional assertions based on state** - use `if/else` to verify different expectations per state
- **Always verify loading is complete** - use `expect(loading).not.toBeVisible()` after state checks

## Mobile-Specific Patterns

- **Use `{ force: true }` for bottom navigation clicks** - Astro dev toolbar intercepts pointer events
- **Switch to correct tab before verifying UI** - tab-specific elements only visible in their tab

## Running Tests

```bash
npm run test:e2e          # Run all tests
npm run test:e2e:ui       # Interactive UI mode
npm run test:e2e:debug    # Debug mode with inspector
npx playwright test file  # Run specific file
```

## Configuration

- **Only Chromium/Desktop Chrome** browser (per project guidelines)
- **Auth state stored** in `playwright/.auth/user.json`
- **Screenshots on failure** - saved to `test-results/`
- **Traces on retry** - for debugging failed tests
